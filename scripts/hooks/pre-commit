#!/bin/bash

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

EXIT_CODE=0

while IFS= read -r FILE; do
    # Only check text-based files (common monorepo extensions)
    if [[ "$FILE" =~ \.(py|go|cs|cpp|js|ts|json|yaml|yml|md|txt|conf|sh)$ ]]; then
        
        # Check if the file ends with a newline
        # Using 'tail' to check the last character
        if [ -n "$(tail -c 1 "$FILE")" ]; then
            echo "ðŸ”§ Fixing missing EOF newline in: $FILE"
            
            # Append a newline to the file
            # Portable sed: works on both Linux (GNU) and macOS (BSD)
            if sed --version >/dev/null 2>&1; then
                # GNU sed (Linux)
                sed -i -e '$a\' "$FILE"
            else
                # BSD sed (macOS)
                sed -i '' -e '$a\' "$FILE"
            fi
            
            # Re-stage the file so the fix is included in the commit
            git add "$FILE"
            
            # Mark that we modified something (optional: causes commit to fail 
            # so user can review, but here we just auto-fix and proceed)
            # EXIT_CODE=1 
        fi
    fi
done <<< "$STAGED_FILES"

exit $EXIT_CODE
